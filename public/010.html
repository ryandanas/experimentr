<!DOCTYPE html>
<meta charset="utf-8">
<title>Survey</title>
<script src="scripts/d3/d3.min.js" charset="utf-8"></script>
<script src="experimentr.js"></script>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<link rel="stylesheet" type="text/css" href="css/toyfinder.css" />

<body>
</body>

<script>
  /* 
  all data is recorded in _<taskID>_<metric> form
  the <taskID> should denote the trial conditions (see example below)
  generic, parameterized code goes here. anything task specific goes in their module

  CONDITIONS
  experimentID     order of the tasks
  taskID           the task, which is composed of independent variables
  spec            which specification (ex// G = gradebook spec)
  phrasing        which phrasing      (ex// O = original phrasing)
  model           which model         (ex// M = minimal model)
  */
  function getexperiment() {
    return ['modules/AOW.html', 'modules/gEC.html'];
    /*
    if(Math.random() < .5) { return ['modules/AOM.html'] }
    else { return ['modules/AOC.html'] }
    */
  }
  var data = {};
  var experiment = getexperiment(); 
  var experimentID = experiment.toString();
  var task = 0;
  var taskID = null;
  var lasthover = null;
  var taskEdits = null;
  var taskExit = null;
  function getsequence() {
    var pre = ['modules/consent/'];
    var post = ['modules/debrief/'];
    var tasks = experiment;
    //return tasks;
    return pre.concat(tasks).concat(post);
  }
  /* GENERIC TASK FUNCTIONS */
  function init(edits, exit) {
    taskID = experiment[task];
    taskEdits = edits;
    taskExit = exit; 
    data = {};
    data['userAgent'] = navigator.userAgent;
    data['experimentID'] = experimentID;
    data[taskID+'_start'] = Date.now();
    data[taskID+'_attempts'] = 0;
    data[taskID+'_attempttime'] = [];
    data[taskID+'_attemptcode'] = [];
    //
    experimentr.hideNext();
    d3.select("#topbar").text("Task "+(task+1)+" of "+experiment.length);
    d3.selectAll('select').attr("disabled", "disabled");
    d3.select("#ready").selectAll("button").attr("disabled", "disabled");
  }
  function understand(iknow) {
    data[taskID+'_iunderstand'] = iknow;
    //
    d3.select("#understand").selectAll("button").attr("disabled", "disabled");
    d3.select("#ready").selectAll("button").attr("disabled", null);
  }
  function ready(gotit) {
    data[taskID+'_iready'] = gotit;
    //
    d3.select("#ready").selectAll("button").attr("disabled", "disabled");
    d3.selectAll('select').attr("disabled", null);
    d3.selectAll('select').on('change', check);
    d3.selectAll('option').on('click', attempt);
  }
  /* EDIT FUNCTIONS */
  function check() {
    var select = d3.event.target;
    var option = select.options[select.selectedIndex];
    option.click();
  }
  function attempt() {
    if(!d3.event.target.disabled) {
      var atime = Date.now() - data[taskID+'_start'];
      var acode = d3.event.target.id;
      data[taskID+'_attempts'] = data[taskID+'_attempts'] + 1;
      data[taskID+'_attempttime'] = (data[taskID+'_attempttime']).concat([atime]);
      data[taskID+'_attemptcode'] = (data[taskID+'_attemptcode']).concat([acode]);
      //
      if (taskEdits[acode]=="") {
        pass();
      } 
      else if(taskEdits[acode]==null) {
        fail(null);
      }
      else if(!taskEdits[acode].startsWith("#")) {
        fail(taskEdits[acode]);
      }
      else {
        var feedback = "The following goals are unsatisfied:<br/>";
        d3.selectAll(taskEdits[acode]).each(function() {
          feedback = feedback+"  "+d3.select(this).text()+"<br/>";
        });
        fail(feedback);
      }
    }
  }
  function fail(feedback) {
    var opt = d3.select(d3.event.target); 
    var id = opt.attr("id");
    opt.style("background-color", "#faa");
    opt.style("text-decoration" , "line-through");
    opt.attr("disabled", "disabled");
    var msg = "This option does not satisfy all goals in a single change. ";
    if(feedback!=null) {
      msg = msg+feedback+"<br/>";
    }
    d3.selectAll('select').attr("disabled", "disabled");
    d3.select("#feedback").html(msg+"<button onclick='reset()'>Okay. Reset the options and I'll try again.</button>");
  }
  function reset() {
    d3.select("#feedback").html("");
    d3.selectAll('select').property('selectedIndex', 0);
    d3.selectAll('select').attr("disabled", null);
  }
  function pass() {
    data[taskID+'_end'] = Date.now();
    data[taskID+'_time'] = parseFloat(data[taskID+'_end']) - parseFloat(data[taskID+'_start']);
    experimentr.addData(data);
    // 
    var msg = "Correct! This option satisfies all goals in a single change.<br/>Before continuing, please answer the following question: "+taskExit+"<br/>";
    d3.selectAll('select').attr("disabled", "disabled");
    d3.select("#feedback").html(msg+"<button onclick='done(false)'>No</button><button onclick='done(true)'>Yes</button>");
  }
  function done(gotit) {
    task = task + 1;
    d3.select("#topbar").text("");
    data[taskID+'_exitq'] = gotit;
    experimentr.addData(data);
    experimentr.next();
  }
  experimentr.sequence(getsequence()).start();
</script>
