<!DOCTYPE html>

<meta charset="utf-8">
<title>Survey</title>

<script src="components/codemirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="components/codemirror/lib/codemirror.css">
<script src="components/codemirror/mode/clike/clike.js"></script>
<script src="components/d3js/d3.v3.min.js"></script>
<script src="experimentr.js"></script>

<style>
  * {
      color: #333;
      font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
    }
  body {
    margin: auto auto auto auto;
    width: 1080px;
  }
  button {
    font-size: large; 
  }
  h1 {
    font-size: 150%;
    margin-top: 0em;
    margin-bottom: .5em;
    margin-left: 0;
    margin-right: 0;
    font-weight: normal;
  }
  ul, ol {
    margin-top: 0em;
    margin-bottom: 0em;
    margin-left: 0em;
    margin-right: 0em;
    padding-left: 1.5em;
  }
  b{
    font-weight: normal;
    text-shadow : 0 0 0 #333;
  }
  i {
    text-shadow : 0 0 0 #333;
  }
  u {
    text-shadow : 0 0 0 #333;
  }
  #experimentr {
    margin: 0em auto 0em auto;
    width: 1080px;
  }
  #control {
    margin-top: 1em;
  }
  #next-button {
    float: right;
    font-size: xx-large;
    font-weight: bold;
  }
  #specification, #assertion, #question, #scenarios, #teacher {
    border: 1px solid #AAA;
    border-radius: 5px;
    padding: 5px;
    margin: 0px 0px 0px 0px;
    background: #CCC;
  }
  #spec, #assert, #quest, #scenario, #teach {
    border: 1px solid #AAA;
    border-radius: 5px;
    padding: 5px;
    background: #FFF;
  }
  #specification {
    width: 50%;
    float:left;
  }
  #assertion{
    width: 50%;
    float: left;
  }
  #question{
    width: 45%;
    float: right;  
  }
  #scenarios {
    width: 45%;
    float: right;
    margin: 15px 0px 15px 0px;
  }
  #teacher {
    width: 45%;
    float: right;
  }
</style>

<body></body>

<script>
/* OVERALL EXPERIMENT FUNCTIONS */
function getexperiment() {
    if(Math.random() < .5) { return ['modules/+GOM.html','modules/+AOM.html'] }
    else { return ['modules/+GOC.html','modules/+AOC.html'] }
}
  var data = {};
  var experiment = getexperiment(); 
  var experimentID = experiment.toString();
  var junktimer;
  function getsequence() {
    var pre = ['modules/consent.html'];
    var teach = [];
    var post = ['modules/debrief.html'];
    var tasks = teach.concat(experiment);
    return pre.concat(tasks).concat(post);
  }
/* GENERIC TASK FUNCTIONS */
  function runalloy () run("alloy");
  function runaluminum () run("aluminum");
  function run (url){
    var req = new XMLHttpRequest();
    var url = "/"+url+"?spec="+encodeURIComponent(specCM.getValue()+assertCM.getValue());
    req.open("GET", url, false);
    req.send();
    var response = req.response.split('\n');
    var status = response[0];
    response.shift();
    var info = response.join('\n');
    d3.select("#status").text(status);
    // failed
    if(status=="ASSERTION IS FALSE")
    {
      foo(tid, specCM.getValue());
      scenarioCM.setValue(prettyScenario(info));
    }
    // pass
    else if (status=="ASSERTION IS TRUE")
    {
      foo(tid, specCM.getValue());
      bar(tid, "PASS");
      scenarioCM.setValue(info);
    }
    // other, probably syntax error
    else 
    {
      scenarioCM.setValue(info);
    }
  }
  function prettyScenario(info) {
    var pretty = "";
    for(line of info.split('\n'))
    {
      if (line.startsWith("this") & line.contains("<:"))
      {
        pretty = pretty + line.split("=")[0] + " :=\n";
        for (subline of (line.split("=")[1]).split(",")){
          pretty = pretty + "\t\t\t\t" + subline + "\n";
        }
      }
      else if (line.startsWith("skolem"))
      {
        pretty = pretty+line+"\n";
      }
    }
    return pretty;
  }
  function init(taskID) {
    data = {};
    data['experimentID'] = experimentID;
    data['_start_'+experimentID+'_'+taskID] = Date.now();
    data['_clicks_'+experimentID+'_'+taskID] = 0;
    data['_clicktime_'+experimentID+'_'+taskID] = [];
    data['_specs_'+experimentID+'_'+taskID] = [];
    data['_events_'+experimentID+'_'+taskID] = [];
    junktimer = Date.now();
    //
    experimentr.hideNext();
    if (taskID.slice(-1)=="M"){
      d3.select("#run").on('click', runaluminum);
      runaluminum();
    }
    else
    {
      d3.select("#run").on('click', runalloy);
      runalloy();
    }
  }
  function foo(taskID, spec) {
    //
    data['_clicks_'+experimentID+'_'+taskID] = data['_clicks_'+experimentID+'_'+taskID] + 1;
    var ctime = Date.now() - data['_start_'+experimentID+'_'+taskID];
    data['_clicktime_'+experimentID+'_'+taskID] = (data['_clicktime_'+experimentID+'_'+taskID]).concat([ctime]);
    data['_specs_'+experimentID+'_'+taskID] = (data['_specs_'+experimentID+'_'+taskID]).concat([spec]);
    //
    d3.select("#attempts").text(8 - data['_clicks_'+experimentID+'_'+taskID]);
    if(data['_clicks_'+experimentID+'_'+taskID] > 7)
    {
      bar(taskID, "FAIL");
    }
  }
  function bar(taskID, result) {
    d3.selectAll('button').attr('disabled', true);
    //
    data['_end_'+experimentID+'_'+taskID] = Date.now();
    data['_result_'+experimentID+'_'+taskID] = result;
    data['_time_'+experimentID+'_'+taskID] = parseFloat(data['_end_'+experimentID+'_'+taskID]) - parseFloat(data['_start_'+experimentID+'_'+taskID]);
    var diff = Date.now() - junktimer;
    experimentr.addData(data);
    experimentr.clearNext();
    experimentr.showNext();
    d3.select("#next-button").attr("disabled",null);
  }
  function userclick(e) {
    var e = d3.event;
    e = e || window.event;
    var target = e.target || e.srcElement;
    if(target.id){
      userevent(tid, "click@"+target.id);
    }
  };
  function userevent(taskID, e) {
    if(taskID)
    {
      var etime = Date.now() - data['_start_'+experimentID+'_'+taskID];
      data['_events_'+experimentID+'_'+taskID] = (data['_events_'+experimentID+'_'+taskID]).concat([e,etime]);
    }
  };
  /* DOCUMENTATION
   all data is recorded in _<metric>_<experimentID><taskID> form
   the <experimentID><taskID> should denote the trial conditions (see example below)
   generic, parameterized code goes here. anything task specific goes in their module
   sorry for the obfuscated names. i did that to avoid quick CTRL+F to win cheaters.
   */
  /*
   CONDITIONS
   experimentID     order of the tasks
   spec             G(gradebook), A(addressbook)
   phrasing         O(original), R(rephrase)
   scenario         M(minimal), C(control)
   */
   experimentr.sequence(getsequence()).start();
</script>
